<p>大家好，我是拾壹，前面介绍过如何安装es搜索引擎，但如何保证数据库跟es索引库的数据同步问题呢，现有成熟的方法很多，以下方法根据自己需求选其一就可，本文主要介绍通过logstash如何同步</p>
<ol>
<li>业务代码中通过代码实现同步</li>
<li>通过canal同步</li>
<li>通过logstash同步</li>
</ol>
<h4><a id="1linuxlogstash_5"></a>1.linux安装logstash</h4>
<p>可前往官网地址下载压缩包：<a href="https://www.elastic.co/cn/downloads/logstash" target="_blank">点此跳转</a></p>
<h4><a id="2_8"></a>2.解压压缩包</h4>
<pre><div class="hljs"><code class="lang-sql">cd usr<span class="hljs-operator">/</span><span class="hljs-keyword">local</span>
tar zxvf logstash<span class="hljs-operator">-</span>x.x.x.tar.gz
</code></div></pre>
<h4><a id="3mysql_13"></a>3.上传mysql驱动包</h4>
<p>上传此jar包：mysql-connector-java-5.1.47.jar</p>
<h4><a id="4sqlitemsql_16"></a>4.创建sql文件,item.sql</h4>
<pre><div class="hljs"><code class="lang-sql"><span class="hljs-keyword">select</span> id,title,avatar,content <span class="hljs-keyword">from</span> b_article <span class="hljs-keyword">where</span> update_time <span class="hljs-operator">&gt;=</span> :sql_last_value <span class="hljs-keyword">and</span> is_publish<span class="hljs-operator">=</span><span class="hljs-number">1</span>
</code></div></pre>
<h4><a id="5mysqltoesconf_21"></a>5.创建同步的配置文件,mysqltoes.conf</h4>
<pre><div class="hljs"><code class="lang-sql">input {

  # 多张表的同步只需要设置多个jdbc的模块就行了
  jdbc {
      # mysql 数据库链接,shop为数据库名
      jdbc_connection_string <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> &quot;jdbc:mysql://127.0.0.1:3306/blog_new?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=UTC&amp;rewriteBatchedStatements=true&quot;
      # 用户名和密码
      jdbc_user <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> &quot;root&quot;
      jdbc_password <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> &quot;root&quot;

      # 驱动
      jdbc_driver_library <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> &quot;/usr/local/logstash-7.9.3/mysql/mysql-connector-java-5.1.47.jar&quot;

      # 驱动类名
      jdbc_driver_class <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> &quot;com.mysql.jdbc.Driver&quot;

      #是否分页
      jdbc_paging_enabled <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> &quot;true&quot;
      jdbc_page_size <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> &quot;50000&quot;


      # 执行的<span class="hljs-keyword">sql</span> 文件路径<span class="hljs-operator">+</span>名称
      statement_filepath <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> &quot;/usr/local/logstash-7.9.3/mysql/item.sql&quot;

      # 默认列名转换为小写
      lowercase_column_names <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> &quot;false&quot;
	# 是否开启记录上次追踪结果
	use_column_value <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-literal">true</span>
	# 记录上一次追踪的结果值
	last_run_metadata_path <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> &quot;/usr/local/logstash-7.9.3/sync/track_time&quot;
	 tracking_column <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> &quot;update_time&quot;
      #设置监听间隔  各字段含义（由左至右）分、时、天、月、年，全部为<span class="hljs-operator">*</span>默认含义为每分钟都更新
      schedule <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> &quot;* * * * *&quot;

      # 索引类型
      type <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> &quot;_doc&quot;
    }

}


output {
  elasticsearch {
        #es的ip和端口
        hosts <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> [&quot;http://127.0.0.1:9200&quot;]
        #ES索引名称（自己定义的）
        index <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> &quot;blog&quot;
        #文档类型
        document_type <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> &quot;_doc&quot;
        #设置数据的id为数据库中的字段
        document_id <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> &quot;%{id}&quot;
    }
    stdout {
        codec <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> json_lines
    }

}

</code></div></pre>
<h4><a id="6logstash_82"></a>6.启动logstash</h4>
<pre><div class="hljs"><code class="lang-sql">nohup .<span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>logstash <span class="hljs-operator">-</span>f config<span class="hljs-operator">/</span>mysqltoes.conf <span class="hljs-operator">&amp;</span>
</code></div></pre>
<p>至此logstash安装结束，会每秒进行检测并同步，如启动不成功或没有同步可将启动方式修改为./bin/logstash -f config/mysqltoes.conf，会打印出日志</p>
